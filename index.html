<!DOCTYPE html>
<html lang="en">
<head>
<title>Activity Tracker</title>
<link rel='stylesheet' type='text/css' href='css/fullcalendar.css' />
<link rel="stylesheet" href="http://code.jquery.com/ui/1.9.1/themes/base/jquery-ui.css" />
<link rel="stylesheet" href="bootstrap/css/bootstrap_wo_icons.min.css" />
<link rel="stylesheet" href="bootstrap/css/bootstrap-responsive.min.css" />
<link rel="stylesheet" href="font_awesome/css/font-awesome.min.css">
<link rel="stylesheet" href="css/global.css" />

<style media="screen" type="text/css">
  form.inline, div.inline {
    display:inline-block;
  }
  .text-center {
    text-align:center;
  }
  .form-condensed label.checkbox {
    margin-top: 0;
    margin-bottom: 5px;
  }
  .form-horizontal .control-label {
    width: 60px;
  }
  .form-horizontal .controls {
    margin-left: 80px;
  }
  .form-horizontal .emotion-tags .control-label{
    width: 100px;
  }
  .form-horizontal .emotion-tags .controls {
    margin-left: 120px;
  }
  .alert {
    padding: 8px 14px 8px 14px;
  }
  .label-alert {
    background-color: #FCF8E3;
    border: 1px solid #FBEED5;
  }
  .input-tag {
    margin:5px;
  }
  .input-tag input {
    margin:0px;
  }
  button i.icon-ok {
    color:#468847;
  }
</style>

<script type="text/javascript" src="config.js"></script>
<script type="text/javascript" src="js/jquery-1.8.2.js"></script>
<script type="text/javascript" src="js/vendor/jquery-ui-1.9.2.custom.min.js"></script>
<script type="text/javascript" src="bootstrap/js/bootstrap.js"></script>
<script type="text/javascript" src="js/vendor/underscore-1.4.2.min.js"></script>
<script type="text/javascript" src="js/underscore-t.js"></script>
<script type="text/javascript" src="js/vendor/knockout-2.2.min.js"></script>
<script type="text/javascript" src="js/our_knockout_extensions.js"></script>
<script type="text/javascript" src="js/vendor/backbone-0.9.9.dev.js"></script>
<script type="text/javascript" src="js/backbone_knockout_view.js"></script>

<script type="text/javascript" src="dynamo/Core.js"></script>
<script type="text/javascript"> Dynamo.TriremeURL = Config.TriremeURL; </script>
<script type="text/javascript" src="dynamo/Core.Models.js"></script>
<script type="text/javascript"> Dynamo.XelementClass = eval(Config.DynamoXelementClass); </script>
<script type="text/javascript" src="dynamo/Core.Collections.js"></script>
<script type="text/javascript" src="dynamo/Core.Views.js"></script>

<script type="text/javascript" src="dynamo/Questions.Models.js"></script>
<script type="text/javascript" src="dynamo/Questions.Collections.js"></script>
<script type="text/javascript" src="dynamo/Questions.Views.js"></script>

<script type="text/javascript" src="dynamo/Guides.Models.js"></script>
<script type="text/javascript" src="dynamo/Guides.Collections.js"></script>
<script type="text/javascript" src="dynamo/Guides.Views.js"></script>

<script type="text/javascript" src="js/site-wide-stuff.js"></script>
<!--   
see http://arshaw.com/fullcalendar/docs for details
 -->
<script type='text/javascript' src='js/vendor/fullcalendar.js'></script>
<script type='text/javascript' src='js/our_calendar_class.js'></script>

<script type='text/javascript' src='js/slider.js'></script>

<script type='text/javascript' src='js/our_filter_class.js'></script>
<script type='text/javascript' src='js/our_filter_class_instance.js'></script>

<script id="event-form-template" type='text/html'>
  <div class="row-fluid accordion-header">
    <legend class="span11"><span class="legend-header">Event Editor</span></legend>
    <div class="span1 caret-icons">
      <i class="icon-caret-right pull-right"></i>
    </div>
  </div>

  <form class="form-horizontal form-condensed accordion-body" style="margin:10px;">
    <div class="row-fluid">
      <div class="control-group span12">
        <label class="control-label">Title</label>
        <div class="controls">
          <input type="text" 
                placeholder="Description"
                class="input-xlarge"
                data-bind="value: title">
          <div style="font-size: 24.5px;" class="inline text-prog-gray">
            <i class="icon-question-sign"></i>
          </div>
        </div>
      </div>
    </div>

    <!-- Start and End Times -->
    <div class="control-group">
      <label class="control-label">Starts</label>
      <div class="controls">
        <select data-bind="value: start_month" class="input-mini">
          <option value="0">Jan</option>
          <option value="1">Feb</option>
          <option value="2">Mar</option>
          <option value="3">Apr</option>
          <option value="4">May</option>
          <option value="5">June</option>
          <option value="6">July</option>
          <option value="7">Aug</option>
          <option value="8">Sept</option>
          <option value="9">Oct</option>
          <option value="10">Nov</option>
          <option value="11">Dec</option>
        </select>
        <input  type="text" 
                placeholder="dd" 
                class="input-xmini" 
                data-bind="value: start_date">
        <input  type="text" 
                placeholder="yyyy" 
                class="input-xmini" 
                data-bind="value: start_year">
        <select data-bind="value: start_hour" class="input-small">
          <option value="0">12 am</option>
          <option value="1">1 am</option>
          <option value="2">2 am</option>
          <option value="3">3 am</option>
          <option value="4">4 am</option>
          <option value="5">5 am</option>
          <option value="6">6 am</option>
          <option value="7">7 am</option>
          <option value="8">8 am</option>
          <option value="9">9 am</option>
          <option value="10">10 am</option>
          <option value="11">11 am</option>
          <option value="12">12 pm</option>
          <option value="13">1 pm</option>
          <option value="14">2 pm</option>
          <option value="15">3 pm</option>
          <option value="16">4 pm</option>
          <option value="17">5 pm</option>
          <option value="18">6 pm</option>
          <option value="19">7 pm</option>
          <option value="20">8 pm</option>
          <option value="21">9 pm</option>
          <option value="22">10 pm</option>
          <option value="23">11 pm</option>
        </select>
        <input  type="text" 
                placeholder="min" 
                class="input-xmini" 
                data-bind="value: start_minute">
      </div>
    </div>
    <div class="control-group">
      <label class="control-label">Ends</label>
      <div class="controls">
        <select data-bind="value: end_month" class="input-mini">
          <option value="0">Jan</option>
          <option value="1">Feb</option>
          <option value="2">Mar</option>
          <option value="3">Apr</option>
          <option value="4">May</option>
          <option value="5">June</option>
          <option value="6">July</option>
          <option value="7">Aug</option>
          <option value="8">Sept</option>
          <option value="9">Oct</option>
          <option value="10">Nov</option>
          <option value="11">Dec</option>
        </select>
        <input  type="text" 
                placeholder="dd" 
                class="input-xmini" 
                data-bind="value: end_date">
        <input  type="text" 
                placeholder="yyyy" 
                class="input-xmini" 
                data-bind="value: end_year">
        <select data-bind="value: end_hour" class="input-small">
          <option value="0">12 am</option>
          <option value="1">1 am</option>
          <option value="2">2 am</option>
          <option value="3">3 am</option>
          <option value="4">4 am</option>
          <option value="5">5 am</option>
          <option value="6">6 am</option>
          <option value="7">7 am</option>
          <option value="8">8 am</option>
          <option value="9">9 am</option>
          <option value="10">10 am</option>
          <option value="11">11 am</option>
          <option value="12">12 pm</option>
          <option value="13">1 pm</option>
          <option value="14">2 pm</option>
          <option value="15">3 pm</option>
          <option value="16">4 pm</option>
          <option value="17">5 pm</option>
          <option value="18">6 pm</option>
          <option value="19">7 pm</option>
          <option value="20">8 pm</option>
          <option value="21">9 pm</option>
          <option value="22">10 pm</option>
          <option value="23">11 pm</option>
        </select>
        <input  type="text" 
                placeholder="min" 
                class="input-xmini" 
                data-bind="value: end_minute">
      </div>
    </div>

    <div class="control-group">
      <label class="control-label">Tags (<span data-bind="text: tags().length"></span>)</label>
      <div class="controls">
        <div data-bind="foreach: { data: tags, as: 'tag' }">
          <div class="input-tag">
            <input type="text" data-bind="value: tag.value, valueUpdate: 'afterkeydown'" />
            <button class="btn" data-bind="click: tag.remove"><i class="icon-remove"> Remove</i></button>
          </div>
        </div>
        <button class="btn" data-bind="click: tags_addElement"><i class="icon-plus"></i> Add Tag</button>
      </div>
    </div>

    <div class="control-group" data-bind="if: inReviewing">
      <label class="pull-left" style="padding-right:10px;padding-top: 5px;text-align: right;margin-bottom: 5px;">Completed This Activity</label>
      <div id="event_completed_container" class="controls">
        <label class="radio inline">
          <input type="radio" value="0" data-bind="checked: eventCompleted" />No
        </label>
        <label class="radio inline">
          <input type="radio" value="1" data-bind="checked: eventCompleted" />Yes 
        </label>
      </div>
    </div>    

    <div class="control-group">
        
      <!-- predict PLEASURE -->
      <div data-bind="if: inScheduling">
        <div class="text-center" style="font-weight:bold;padding:5px 0px;">
          Please rate your predicted PLEASURE during the event
        </div>
        <div class="row-fluid">
          <div class="span11">
            <div id="predict-slider" class="slider" style="margin-top: 3px;" data-bind="slider: predicted_pleasure, sliderOptions: {min: 0, max: 10, value: 5, range: 'min', step: 1}"></div>
          </div>
          <div class="span1">
            <strong data-bind="text: predicted_pleasure, valueUpdate: 'afterkeydown'" style="font-size:2em;"></strong>
          </div>
        </div>
      </div>

      <!-- report actual PLEASURE -->
      <div data-bind="ifnot: inScheduling">
        <div class="text-center" style="font-weight:bold;padding:5px 0px;">
          Please rate your actual PLEASURE during the event
        </div>
        <div class="row-fluid">
          <div class="span11">
            <div class="slider" style="margin-top: 3px;" data-bind="slider: actual_pleasure, sliderOptions: {min: 0, max: 10, value: 5, range: 'min', step: 1}"></div>
          </div>
          <div class="span1">
            <strong data-bind="text: actual_pleasure, valueUpdate: 'afterkeydown'" style="font-size:2em;"></strong>
          </div>
        </div>
      </div>

      <!-- show previously predicted PLEASURE -->
      <div data-bind="if: inReviewing" class="row-fluid text-prof-blue">

        <div class="span11">
          <strong class="pull-right"><i class="icon-lightbulb"></i> Predicted Pleasure:</strong>
        </div>
        <div class="span1">
          <strong data-bind="text: predicted_pleasure, valueUpdate: 'afterkeydown'"></strong>
        </div>

      </div>

    </div>

    <div class="row-fluid">

      <!-- predict ACCOMPLISHMENT -->
      <div data-bind="if: inScheduling">
        <div class="text-center" style="font-weight:bold;padding:5px 0px;">
          Please rate your predicted ACCOMPLISHMENT during the event
        </div>
        <div class="row-fluid">
          <div class="span11">
            <div class="slider" style="margin-top: 3px;" data-bind="slider: predicted_accomplishment, sliderOptions: {min: 0, max: 10, value: 5, range: 'min', step: 1}"></div>
          </div>
          <div class="span1">
            <strong data-bind="text: predicted_accomplishment, valueUpdate: 'afterkeydown'" style="font-size:2em;"></strong>
          </div>
        </div>
      </div>

      <!-- report actual ACCOMPLISHMENT -->
      <div data-bind="ifnot: inScheduling">
        <div class="text-center" style="font-weight:bold;padding:5px 0px;">
          Please rate your actual ACCOMPLISHMENT during the event
        </div>
        <div class="row-fluid">
          <div class="span11">
            <div class="slider" style="margin-top: 3px;" data-bind="slider: actual_accomplishment, sliderOptions: {min: 0, max: 10, value: 5, range: 'min', step: 1}"></div>
          </div>
          <div class="span1">
            <strong data-bind="text: actual_accomplishment, valueUpdate: 'afterkeydown'" style="font-size:2em;"></strong>
          </div>
        </div>
      </div>

      <!-- show previously predicted ACCOMPLISHMENT -->
      <div data-bind="if: inReviewing" class="row-fluid text-prof-blue">

        <div class="span11">
          <strong class="pull-right"><i class="icon-lightbulb"></i> Predicted Accomplishment:</strong>
        </div>
        <div class='span1'>
          <strong data-bind="text: predicted_accomplishment, valueUpdate: 'afterkeydown'"></strong>
        </div>

      </div>

    </div>
    
    <div data-bind="ifnot: inScheduling">
      <div class="text-center" style="font-weight:bold;padding:5px 0px;">
        Please rate your 
        <select class="input-small" data-bind="value: emotion">
          <option value="">None</option>
          <option value="sad">Sad</option>
          <option value="happy">Happy</option>
          <option value="angry">Angry</option>
          <option value="anxious">Anxious</option>
        </select>
        Intensity
      </div>
      <div class="row-fluid">
        <div class="span11">
          <div class="slider" data-bind="slider: emotion_intensity, sliderOptions: {min: 0, max: 10, value: 0, step: 1}"></div>
        </div>
        <div class="span1">
          <strong data-bind="text: emotion_intensity, valueUpdate: 'afterkeydown'" style="font-size:2em;"></strong>
        </div>
      </div>
      <div data-bind="if: inMonitoring">
        <div class="row-fluid">
          <div class="control-group">
            <label class="control-label">Motivation</label>
            <div class="controls">
              <select data-bind="value: motivation">
                <option value="">None</option>
                <option value="mood_directed">Mood Directed</option>
                <option value="goal_directed">Goal Directed</option>
              </select>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="form-actions" style="padding-left:20px;">
      <button class="save btn btn-primary" data-bind="click: save">Save And Create New Event</button>
      <button class="del btn btn-danger" data-bind="click: destroy"><i class="icon-trash"></i> Delete Event</button>
    </div>
  </form>

</script>

<script id="eventTemplate" type="text/html">
  <div class="patient-health-record-header list-item" data-cid="<%= item.cid %>">
    <h4><%= item.title %></h4>
    <strong>From: </strong><%= item.start.toString() %>
    <div class="clearfix"></div>
    <strong>Until: </strong><%= item.end.toString() %>
    <div class="row-fluid">
      <div class="span6">
        <strong>Pleasure</strong>
        <ul> 
          <li>Predicted: <%= item.predicted_pleasure %></li>
          <li>Actual: <%= item.actual_pleasure %></li>
        </ul>
      </div>
      <div class="span6">
        <strong>Accomplishment</strong>
        <ul>
          <li>Predicted: <%= item.predicted_accomplishment %></li>
          <li>Actual: <%= item.actual_accomplishment %></li>
        </ul>
      </div>
    </div>
    <strong>Emotional Intensity</strong>
    <span><%= item.emotion %> (<%= item.emotion_intensity %>)</span>
  </div>
</script>

<script id="choose-guide-template" type="text/html">
<div class="btn-group">
  <a class="btn dropdown-toggle" data-toggle="dropdown" href="#">
    Choose Guide
    <span class="caret"></span>
  </a>
  <ul id="guides-list" class="dropdown-menu">
    <% _.each(elements, function(e) { %>
      <li><a><span class="choose_element" data-guid="<%= e.id %>"><%= e.html %></span></a></li>
    <% }) %>
  </ul>
</div>
</script>

<script id="guides-template" type="text/html">
<div id="guides" class="accordion-container header-well swell">
  <div class="row-fluid accordion-header">
    <legend class="span11">
      <span class="legend-header">Guides</span>
      <div id="guide-select" class="btn-group pull-right"></div>
    </legend>
    <div class="span1 caret-icons"><i class="icon-caret-right pull-right"></i></div>
  </div>
  <div class="accordion-body">
    <div id="current-slide" class="well-white well well-small" style="margin-bottom:0px;">
      <div style="margin:0 auto; text-align:center;">
        <h3> Choose a Guide using the dropdown menu above</h3>
      </div>
    </div>
    <ul class="pager">
      <li><a class="previous">&larr; Previous</a></li>
      <li><a class="next">Next &rarr;</a></li>
    </ul>
  </div>
</div>
</script>

<script type="text/javascript">

Dynamo.AUTHENTICATING_USER_ID = function() { return "TEST-USER-GUID" };

ActivityCalEvent = Dynamo.Data.extend({

  defaultDataAtts: function() {
    var now = new Date(),
        y = now.getFullYear(),
        m = now.getMonth(),
        d = now.getDate(),
        h = now.getHours(),
        min = now.getMinutes();
    return {
      // id: 1,
      title: ["string", ""],
      allDay: ["boolean", false],
      start: ["datetime", new Date(y, m, d, h+1, 00)],
      end: ["datetime", new Date(y, m, d, h+2, 00)],
      tags: ["array", []],
      predicted_pleasure: ["number", null],
      predicted_accomplishment: ["number", null],
      actual_pleasure: ["number", null],
      actual_accomplishment: ["number", null],  
      emotion: ["string", null],
      emotion_intensity: ["number", null],
      motivation: ["string", null],
      eventCompleted: ["boolean", null]
    }
  }

});

GoalsView = Backbone.View.extend({

  className: "row-fluid",

  initialize: function() {
    _.bindAll(this);
    this.currentStatusToDisplay = "display-all";
    this.displayAllBtnClass = "";
    this.unansweredBtnClass = "";
    this.completedBtnClass = "";
    this.ignoredBtnClass = "";
    this.goals = this.options.goals;
    this.goalData = this.options.goalData;
  },

  events: {
    "click .display-all": "setToAll",
    "click .unanswered": "setToUnanswered",
    "click .completed": "setToCompleted",
    "click .ignored": "setToIgnored"
  },

  setToAll: function() {
    this.currentStatusToDisplay = "display-all";
    this.render();
  },
  setToUnanswered: function() {
    this.currentStatusToDisplay = "unanswered";
    this.render();
  },

  setToCompleted: function() {
    this.currentStatusToDisplay = "completed";
    this.render();
  },  

  setToIgnored: function() {
    this.currentStatusToDisplay = "ignored";
    this.render();
  },

  template: function() {
    this.setButtonStatus();
    return _.template(''+
      '<div id="goals-accordion-header" class="row-fluid"><legend class="span11"><span class="legend-header">Goals</span>'+
      '<div class="btn-group pull-right">'+
        '<button data-status="unanswered" type="button" class="goals-btn btn unanswered '+this.unansweredBtnClass+'">Current</button>'+
        '<button class="btn dropdown-toggle" data-toggle="dropdown">'+
          '<span class="caret"></span>'+
        '</button>'+
        '<ul class="dropdown-menu">'+
          '<li><a data-status="display-all" type="button" class="goals-btn display-all '+this.displayAllBtnClass+'">All</a></li>'+
          '<li><a data-status="completed" type="button" class="goals-btn completed '+this.completedBtnClass+'" style="color:green;">Completed</a></li>'+
          '<li><a data-status="ignored" type="button" class="goals-btn ignored '+this.ignoredBtnClass+'" style="color:#b30000;">Ignored</a></li>'+
        '</ul>'+
      '</div>'+
      '</legend>'+
      '<div class="span1 caret-icons"><i class="icon-caret-right pull-right"></i></div></div>'+
      '<ul id="goals" class="accordion-body"></ul>');
  },

  // filterGoalData: function(clickEvent) {
  //   var target = clickEvent.currentTarget
  //   var status = $(target).data('status')
  //   console.log("status", status)
  //   this.currentStatusToDisplay = status
  //   this.render()
  // },

  goalSnippet: function(goalXEL, alertKlass, alertIcon) {
    var xelementID = goalXEL.id;
    var goalName = goalXEL.metacontent().name;
    var goalDescription = goalXEL.metacontent().description;
    return ""+
      "<li>"+
        "<div class=\"list-item span11 "+alertKlass+"\">" +
          "<div class=\"span1\"><i class=\""+alertIcon+" icon-color\"></i></div>" +
          "<div class=\"span9\">" +
            "<strong>" + goalName + "</strong> - "+goalDescription +
          "</div>" +
          "<div class=\"span2\"><button type=\"button\" class=\"btn set-activity-goal ignore btn-remove btn-mini\" data-dismiss=\"alert\" data-xelement-id=\""+xelementID+"\"><i class=\"icon-remove\"></i></button><button type=\"button\" class=\"btn set-activity-goal btn-ok btn-mini\" data-dismiss=\"alert\" data-xelement-id=\""+xelementID+"\"><i class=\"icon-ok set-activity-goal\" data-xelement-id=\""+xelementID+"\"></i></button></div>" +
        "</div>"+
        "<div class=\"clearfix\"></div>"+
      "</li>"
  },

  appendGoalData: function() {
    var self = this
    var data_to_display = []
    var ul = self.$el.find('ul#goals')
    ActivityCalGoals.each(function(goal_xel) {
      var relevantData = ActivityCalGoalData.find(function(ud) {
        return (ud.get("xelement_id") == goal_xel.id) 
      });
      switch (self.currentStatusToDisplay) {
        case "unanswered":
          self.displayUnansweredGoals(relevantData, ul, self, goal_xel);
        break;
        case "completed":
          self.displayCompletedGoals(relevantData, ul, self, goal_xel);
        break;
        case "ignored":
          self.displayIgnoredGoals(relevantData, ul, self, goal_xel);
        break;
        case "display-all":
          self.displayUnansweredGoals(relevantData, ul, self, goal_xel);
          self.displayCompletedGoals(relevantData, ul, self, goal_xel);
          self.displayIgnoredGoals(relevantData, ul, self, goal_xel);
        break;
      };
    });
    if (ul.find('li').length === 0) {
      ul.html("<div class='span12' style='text-align:center;padding-top: 5px;'><strong>No Goals Exist</strong></div><div class='clearfix'></div>");
    };
  },

  displayUnansweredGoals: function(relevantData, ul, view, goalXel) {
    if (!relevantData.id) {
      ul.append( view.goalSnippet(goalXel, "yellow-header", "icon-remove-sign") );
    }
  },

  displayCompletedGoals: function(relevantData, ul, view, goalXel) {
    if (relevantData.get_field_value('status') == "completed") {
      ul.append( view.goalSnippet(goalXel, "green-header", "icon-ok-sign"));
      // debugger
    };
    ul.find('.green-header button.btn-ok').hide();
  },

  displayIgnoredGoals: function(relevantData, ul, view, goalXel) {
    if (relevantData.get_field_value('status') == "ignored") {
      ul.append( view.goalSnippet(goalXel, "red-header", "icon-exclamation-sign") );
    };
    ul.find('.red-header button.btn-remove').hide();
  },

  placeGoalTooltips: function() {
    this.$el.find("i.icon-remove").tooltip({
      title: "Ignore Goal"
    });
    this.$el.find("i.icon-ok").tooltip({
      title: "Check if Completed"
    });
  },

  render: function() {
    this.$el.html(this.template())
    this.appendGoalData();
    this.setActivityGoalHandlers();
    this.placeGoalTooltips();
    return this
  },

  setButtonStatus: function(){
    var self = this;
    self.displayAllBtnClass = "";
    self.unansweredBtnClass = "";
    self.completedBtnClass = "";
    self.ignoredBtnClass = "";

    switch (this.currentStatusToDisplay) {
      case "display-all":
        self.displayAllBtnClass = "active";
      break;
      case "unanswered":
        self.unansweredBtnClass = "active";
      break;
      case "completed":
        self.completedBtnClass = "active";
      break;
      case "ignored":
        self.ignoredBtnClass = "active";
      break;
    }
  },

  setActivityGoalHandlers: function() {
    self = this;
    this.$el.find('.set-activity-goal').click(function(event) {

      var target = $(event.currentTarget);
      var xelementID = target.data('xelement-id')
      console.log("xelement", xelementID)
      
      var data = ActivityCalGoalData.find(function(goalData) {
        return (goalData.get("xelement_id") == xelementID) 
      });

      if (target.hasClass('ignore')) {
        data.set_field('status', "string", "ignored")
      } else {
        data.set_field('status', "string", "completed")
      };

      data.save();

      console.log("status", data.get_field_value('status'))
      self.render()
    })

  }

});

GuidesView = Dynamo.ChooseOneXelementFromCollectionView.extend({

  initialize: function() {
    this.guideData = this.options.guideData;
  },

  events: {
  	"click .next" : "moveForward",
  	"click .previous" : "moveBack",
  },

  currentSlideIndex: function() {
  	return this._currentSlideIndex;
  },

  moveBack: function() {
  	try {
      this._currentSlideIndex = this._currentSlideIndex - 1;
      if (this._currentSlideIndex < 0) { this._currentSlideIndex = 0 };
      this.renderSlide();  		
  	} 
    catch (e) {
      console.warn("Error when clicking back: ", e);
    }
  },

  moveForward: function() {
    try {
      this._currentSlideIndex = this._currentSlideIndex + 1;
      if (this._currentSlideIndex >= this.currentGuide.slides.length) { 
        debugger;
        this._currentSlideIndex = this.currentGuide.slides.length - 1;
      };
      this.renderSlide();
    }
    catch (e) {
      console.warn("Error when clicking next: ", e);
    }
  },

  resetCurrentSlide: function() {
  	this._currentSlideIndex = 0;
  },

  render: function() {

    var self = this;

    this.$el.html( self._template({}) );

    self.guideSelect = new Dynamo.ChooseOneXelementFromCollectionView({
      template: $("script#choose-guide-template").html(),
      collection: self.collection
    });

    self.guideSelect.on("element:chosen", function() {
      self.currentGuide = self.guideSelect.chosen_element;
      self.currentGuideData = self.guideData.filter(function(guide) { return guide.xelement_id == self.currentGuide.id });
      self.resetCurrentSlide();
      self.renderSlide();
    });

    self.$el.find("div#guide-select").append(self.guideSelect.render().$el);

    return this;

  },

  renderSlide: function() {
  	var currentSlide = this.currentSlideIndex();
    this.$el.find("div#current-slide").html("<h3>"+this.currentGuide.get_field_value("title")+"</h3>");
    this.$el.find("div#current-slide").append( this.currentGuide.slides.at(currentSlide).get_field_value("content") );
    return this;
  }

});


function renderVisualization() {
  currentVisualization.render();
};

function selectedValues(selector) {
  var r = [];
  _.map($('input:checked', selector), function(selected){ 
    r.push( ($(selected).val()) ); 
  });
  return r;
};


// Activity Calendar Specific Filters:

eventFilters.add(function (event) {

  var expFilters = selectedValues("#experience-filters");

  if ( _.isEmpty(expFilters) ) { return true };

  var passed = true;
  if ( _.contains(expFilters, "low_predicted_pleasure") &&
     (event.get_field_value("predicted_pleasure") > 4 ) )           { passed = false };
  if ( _.contains(expFilters, "low_actual_pleasure") &&
     (event.get_field_value("actual_pleasure") > 4 ) )              { passed = false }
  if ( _.contains(expFilters, "low_predicted_accomplishment") &&
     (event.get_field_value("predicted_accomplishment") > 4 ) )     { passed = false }
  if ( _.contains(expFilters, "low_actual_accomplishment") &&
     (event.get_field_value("actual_accomplishment") > 4 ) )        { passed = false }
  if ( _.contains(expFilters, "high_predicted_pleasure") &&
     (event.get_field_value("predicted_pleasure") < 6 ) )           { passed = false }
  if ( _.contains(expFilters, "high_actual_pleasure") &&
     (event.get_field_value("actual_pleasure") < 6 ) )              { passed = false }
  if ( _.contains(expFilters, "high_predicted_accomplishment") &&
     (event.get_field_value("predicted_accomplishment") < 6 ) )     { passed = false }
  if ( _.contains(expFilters, "high_actual_accomplishment") &&
     (event.get_field_value("high_actual_accomplishment") < 6 ) )    { passed = false }

  return passed;

});

function filteredEvents() {
  //eventFilters defined in included file: 'filter_class_instance.js'
  return eventFilters.filter(ActivityCalEvents);
}


loadPage = function() {

  // Setup Activity Calendar Goals  

  ActivityCalGoals = new XelementCollection(XELEMENTS.filter(function(xel) {
    return (xel.get_field_value("title") == "Activity Calendar Goal")
  })); 

  ActivityCalGoalData = new DataCollection(null);

  ActivityCalGoals.each(function(goal_xel) {
    var data;

    // Fetch any existing data on the server for this user and goal.
    var dc = new DataCollection(null, {
      xelement_id: goal_xel.id,
      user_id: Dynamo.CURRENT_USER_ID,
      group_id: Dynamo.CURRENT_GROUP_ID      
    });
    dc.fetch({async: false});

    if (dc.length > 0) {
      data = dc.first();
    }
    else {
      // if length is 0, then no data exists, create new object.
      data = new Dynamo.Data({
        server_url: Dynamo.TriremeURL,
        xelement_id: goal_xel.id,
        user_id: Dynamo.CURRENT_USER_ID,
        group_id: Dynamo.CURRENT_GROUP_ID       
      });
    };
    
    ActivityCalGoalData.add(data); 
    // Either way, it gets added to the collection of user data about calendar goals.
  });

  goalsView = new GoalsView({
    goals:  ActivityCalGoals,
    goalData: ActivityCalGoalData
  });

  // Setup Activity Calendar Guides

  ActivityCalGuides = GUIDES;
  // .filter(function(xel) {
  //   return (xel.get_field_value("content_description") == "Activity Calendar Guide")
  // });

  ActivityCalGuideData = new DataCollection(null);

  ActivityCalGuides.each(function(guide_xel) {
    var data;

    //  Fetch any existing data on the server for this user and goal.
    var dc = new DataCollection(null, {
      xelement_id: guide_xel.id,
      user_id: Dynamo.CURRENT_USER_ID,
      group_id: Dynamo.CURRENT_GROUP_ID      
    });
    dc.fetch({async: false});

    if (dc.length > 0) {
      data = dc.first();
    }
    else {
      // If length is 0, then no data exists, create new object.
      data = new Dynamo.Data({
        server_url: Dynamo.TriremeURL,
        xelement_id: guide_xel.id,
        user_id: Dynamo.CURRENT_USER_ID,
        group_id: Dynamo.CURRENT_GROUP_ID       
      });
    };
    
    ActivityCalGuideData.add(data);
    //  Either way, it gets added to the collection of user data about calendar guides.
  });

  guidesViewer = new GuidesView({
    template: $("script#guides-template").html(),
    collection: ActivityCalGuides,
    guideData: ActivityCalGuideData
  });


  // Setup collection of Calendar Events

  ActivityCalEvents = new DataCollection(null, {
    xelement_id: "ACTIVITY-CALENDAR-EVENTS-GUID",
    user_id: Dynamo.CURRENT_USER_ID,
    group_id: Dynamo.CURRENT_GROUP_ID      
  });
  ActivityCalEvents.fetch({ async: false});
  
  ActivityCalEvents.on('add', function() {
    renderVisualization();
  });

  ActivityCalEvents.on('remove', function() {
    renderVisualization();
  });

  //Define editEventView
  editEventView = new ModelBackoutView({
    el: "div#edit-event-form",
    computedAtts: {
      currentState: {
        read: function() {
          var now = new Date(),
              // Needs to exist so that knockout will pick up 
              // on re-computing the read function when something changes. 
              garbage = this.dummyObservable();
              start = this.view.model.get_field_value('start');         
          if ( start > now ) { return "scheduling" };
          if ( this.view.model.id ) { 
            return "reviewing"; 
          } else {
            return "monitoring";
          };
        }
      },
      inScheduling: {
        read: function() {
          this.dummyObservable.notifySubscribers();
          var state = this.currentState();
          console.log("in 'inScheduling'; start, now, currentState =", this.start(), new Date(), state);
          if ( state == "scheduling") { return true; }
          return false;
        },
        deferEvaluation: true
      },
      inMonitoring: {
        read: function() {
          this.dummyObservable.notifySubscribers();
          var state = this.currentState();
          console.log("in 'inMonitoring'; start, now, currentState =", this.start(), new Date(), state);
          if (state == "monitoring") { return true; }
          return false;
        },
        deferEvaluation: true
      },
      inReviewing: {
        read: function() {
          this.dummyObservable.notifySubscribers();
          var state = this.currentState();
          console.log("in 'inReviewing'; start, now, currentState =", this.start(), new Date(), state);
          if (state == "reviewing") { return true; }
          return false;
        },
        deferEvaluation: true
      }                
    },
    modelAttsFn: function(model) {
      return model.get_fields_as_object();
    }, 
    arrayDefaults: {
      "tags": ""
    },
    knockoutTemplate: $('script#event-form-template').html() 
  });

  editEventView.on('model:save', function() {
    editEventView.model.save({async:false});
    ActivityCalEvents.add(editEventView.model, { merge: true });
    editEventView.updateModel(
      new ActivityCalEvent({
        xelement_id: "ACTIVITY-CALENDAR-EVENTS-GUID",
        user_id: Dynamo.CURRENT_USER_ID,
        group_id: Dynamo.CURRENT_GROUP_ID
      })
    );
  });

  editEventView.on('model:delete', function() {
    ActivityCalEvents.remove(editEventView.model);
    editEventView.model.destroy({async:false, success: function() {
      alert('Your event was deleted.');
    }});
    editEventView.updateModel(
      new ActivityCalEvent({
        xelement_id: "ACTIVITY-CALENDAR-EVENTS-GUID",
        user_id: Dynamo.CURRENT_USER_ID,
        group_id: Dynamo.CURRENT_GROUP_ID
      })
    );
  });

  editEventView.updateModel = function(newModelObj) {
    var self = this;
    self.model = null;
    self.model = newModelObj;
    self.model.on('change:fromKnockout', function() {
      var m = self.model
      // More validations needed?
      if (m.get('end') > m.get('start') ) {
        var calEventIds = _.map(calendarEvents, function(calEvent){ return calEvent.id; });
        var eventIndex = _.indexOf(calEventIds, m.cid);

        if (eventIndex != -1) {
          //updating existing event.
          calendarEvents[eventIndex] = _.extend( {}, m.get_fields_as_object(), { id: m.cid } );
        } else {
          //adding a new one.
          calendarEvents.push( _.extend({}, m.get_fields_as_object(), { id: m.cid } ) );  
        };

        renderVisualization();
      
      };
    });
    self.render();
  };

  // RENDER EVERYTHING.

  // render goals
  $('div#log-tracking').html(goalsView.render().$el);


  // render guides
  $('div#guides-container').html(guidesViewer.render().$el);

  // Assign a new model & render editEventView
  editEventView.updateModel(new ActivityCalEvent({
    xelement_id: "ACTIVITY-CALENDAR-EVENTS-GUID",
    user_id: Dynamo.CURRENT_USER_ID,
    group_id: Dynamo.CURRENT_GROUP_ID
  }));

  // setup and render visualization
  currentVisualization = new Calendar('div#activity-list-container', filteredEvents);
  renderVisualization();

  // Visualization Selection Handler
  $('div#visualizations button').click(function(clickEvent) {
    currentVisualization.remove();
    switch($(clickEvent.currentTarget).val()) {
      case "calendar":
        currentVisualization = new Calendar("div#activity-list-container");
        break;
      case "list":
        currentVisualization = new ShowArrayView({
          title: "Events",
          container: 'div#activity-list-container', 
          getArrayFn:  filteredEvents,
          elementTemplate: $('script#eventTemplate').html(),
          onElementClick: function(clickEvent) {
            var event = ActivityCalEvents.get($(clickEvent.currentTarget).data("cid"));
            editEventView.updateModel( event );
            $('div#edit-event-form').effect("highlight", {}, 2000);
          }
        });
        break;
    };
    renderVisualization();
  });

  // Filter Selection Handler
  $('div#filters input').change( function(changeEvent) {
    renderVisualization(); 
  });

  $("button#show-filter-container").live('click', function(e){
    e.preventDefault();
    $("#filters").toggle();
    var button = $(this);
    if (button.hasClass('active')) {
      button.removeClass('active');
    } else {
      button.addClass('active');
    };
    return false;
  });

  $(".accordion-header").live('click', function(event){
    var header = $(this);
    var body = header.closest(".accordion-container").find(".accordion-body");
    if (body.is(":visible")) {
      if (!$(event.target).closest("ul#guides-list").hasClass("dropdown-menu")) {
        body.hide();
        rotateArrowRight(header);
      }
    } else {
      body.show();
      toggleChevronArrow(header);
    }
  });

  $("#goals-accordion-header").live('click', function(event){
    var target = $(event.target);
    var header = $("#goals-accordion-header");
    var body = $("#goals");
    if (target.hasClass('goals-btn')) {
      body.show();
      rotateArrowDown(header);
    } else {
      body.toggle();
      toggleChevronArrow(header);
    };
  });

};

toggleChevronArrow = function(header) {
  if (header.find('i.icon-caret-right').length === 1) {
    rotateArrowDown(header);
  } else {
    rotateArrowRight(header);
  }
}

rotateArrowRight = function(header) {
  header.find('i.icon-caret-down').removeClass('icon-caret-down').addClass('icon-caret-right');
};

rotateArrowDown = function(header) {
  header.find('i.icon-caret-right').removeClass('icon-caret-right').addClass('icon-caret-down');
};

jQuery.fn.displayFormAndDownChevronArrow = function() {
  var container = $(this);
  var body = container.find(".accordion-body");
  if (body.length === 1) {
    body.show()
  };
  toggleChevronArrow(container);
  return $(this);
};

$(function() {

  initializeLoadAndThen(loadPage);
  $("#predict-slider").slider( "value", 5 );

});  

</script>
</head>

      
  <body onunload="">
    <!-- page-container connect -->
    <div class="container-fluid" style="padding-top:20px;">
      <div class="row-fluid">
        <div class="span5">
          <div class="accordion-container header-well swell">
            <div class="row-fluid accordion-header">
              <legend class="span11"><span class="legend-header">To Do</span></legend>
              <div class="span1 caret-icons">
                <i class="icon-caret-down pull-right"></i>
              </div>
            </div>
            <div id="to-do-body" class="accordion-body">
              <div class="well-white well well-small" style="margin-bottom:0px;">
                <ol>
                  <li>Watch the "Monitor Activities" Guide <i class="icon-question-sign"></i></li>
                  <li>Completely monitor your yesterday <i class="icon-question-sign"></i></li>
                  <li>Monitor activities over the course of today <i class="icon-question-sign"></i></li>
                  <li>Come back tomorrow!</li>
                </ol>
              </div>
            </div>
            <!-- to do body -->
          </div>
          <div id="guides-container">
          </div>
          <div id="log-tracking" class="accordion-container header-well swell">
            <!-- <ul id="goals"></ul> -->
          </div>

          <div id="edit-event-form" class="swell header-well accordion-container">
            <!-- form -->
          </div>
          <div class="btn-toolbar">
            <button class="btn"><i class="icon-reply"></i> My Values, My Progress</button>
          </div>
        </div>
        <div class="span7 swell accordion-container">
          <div id="filter-container">
            <div class="accordion-header">
              <legend>
                <span class="legend-header">Visualization</span>
                <div class="btn-group pull-right"><button class="btn" id="show-filter-container"><i class="icon-filter"></i> Filter <b class="caret"></b></button></div>
              </legend>
            </div>
            <div class="row-fluid">
              <div id="filters" class="dropdown-menu span12">
                <div class="span3">
                  <div id="time-filters">
                    <label>Time</label>
                    <label class="checkbox" for="filter-mornings">
                      <input id="filter-mornings" type="checkbox" value="mornings">Mornings
                    </label>

                    <label class="checkbox" for="filter-afternoons">
                      <input id="filter-afternoons" type="checkbox" value="afternoons">Afternoons
                    </label>
                    <label class="checkbox" for="filter-evenings">
                      <input id="filter-evenings" type="checkbox" value="evenings">Evenings
                    </label>
                  </div>
                </div>
                <div class="span3">
                  <div id="topic-filters">
                    <label>Topic</label>
                    <label class="checkbox" for="filter-work">
                      <input id="filter-work" type="checkbox" value="Work">Work
                    </label>
                    <label class="checkbox" for="filter-family">
                      <input id="filter-family" type="checkbox" value="Family">Family
                    </label>
                    <label class="checkbox" for="filter-school">
                      <input id="filter-school" type="checkbox" value="School">School
                    </label>
                    <label class="checkbox" for="filter-chores">
                      <input id="filter-chores" type="checkbox" value="Chores">Chores
                    </label>
                    <label class="checkbox" for="filter-leisure">
                      <input id="filter-leisure" type="checkbox" value="Leisure">Leisure
                    </label>
                    <label class="checkbox" for="filter-self-care">
                      <input id="filter-self-care" type="checkbox" value="Self-care">Self-care
                    </label>
                  </div>
                </div>
                <div class="span3">
                  <div id="experience-filters">
                    <label>Experience</label>
                    <label class="checkbox" for="filter-low-predicted-pleasure">
                      <input id="filter-low-predicted-pleasure" type="checkbox" value="low_predicted_pleasure">Low Pred. Pleasure
                    </label>
                    <label class="checkbox" for="filter-low-actual-pleasure">
                      <input id="filter-low-actual-pleasure" type="checkbox" value="low_actual_pleasure">Low Actual Pleasure
                    </label>
                    <label class="checkbox" for="filter-low-predicted-accomplishment">
                      <input id="filter-low-predicted-accomplishment" type="checkbox" value="low_predicted_accomplishment">Low Pred. Accomplishment        
                    </label>        
                    <label class="checkbox" for="filter-low-actual-accomplisment">
                      <input id="filter-low-actual-accomplisment" type="checkbox" value="low_actual_accomplishment">Low Actual Accomplishment
                    </label>
                    <label class="checkbox" for="filter-high-predicted-pleasure">
                      <input id="filter-high-predicted-pleasure" type="checkbox" value="high_predicted_pleasure">High Pred. Pleasure
                    </label>
                    <label class="checkbox" for="filter-high-actual-pleasure">
                      <input id="filter-high-actual-pleasure" type="checkbox" value="high_actual_pleasure">High Actual Pleasure                
                    </label>
                    <label class="checkbox" for="filter-high-predicted-accomplishment">
                      <input id="filter-high-predicted-accomplishment" type="checkbox" value="high_predicted_accomplishment">High Pred. Accomplishment
                    </label>
                    <label class="checkbox" for="filter-high-actual-accomplishment">
                      <input id="filter-high-actual-accomplishment" type="checkbox" value="high_actual_accomplishment">High Actual Accomplishment
                    </label>
                  </div>
                </div>
                <div class="span3">
                  <div id="emotion-filters">
                    <label>Emotion</label>
                    <label class="checkbox" for="filter-sad">
                      <input id="filter-sad" type="checkbox" value="sad">Sad
                    </label>
                    <label class="checkbox" for="filter-happy">
                      <input id="filter-happy" type="checkbox" value="happy">Happy
                    </label>
                    <label class="checkbox" for="filter-angry">
                      <input id="filter-angry" type="checkbox" value="angry">Angry
                    </label>
                    <label class="checkbox" for="filter-anxious">
                      <input id="filter-anxious" type="checkbox" value="anxious">Anxious
                    </label>
                  </div>
                </div>
              </div>
            </div>
          </div> 
          <div>
            <div id="visualizations" class="row-fluid btn-toolbar">
              <div class="span3">
                <button class="btn btn-block" value="calendar"><i class="icon-calendar"></i> Calendar</button>
              </div>
              <div class="span3">
                <button class="btn btn-block" value="list"><i class="icon-list"></i> List</button>
              </div>
              <div class="span3">
                <button class="btn btn-block" value="list"><i class="icon-signal"></i> Graph</button>
              </div>
              <div class="span3">
                <button class="btn btn-block" value="list"><i class="icon-map-marker"></i> Life Map</button>
              </div>
            </div> 
            <div id="activity-list-container" class="well-small well-white" style="margin-top:0px;padding-top:0px;"></div>
          </div>
        </div>
      </div>
    </div>
  </body>
</html>
